<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Rotulagem YOLO</title>

  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }

    .container {
      position: relative;
      display: inline-block;
    }

    #image {
      max-width: 800px;
      border-radius: 8px;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      cursor: crosshair;
    }

    button, select {
      margin: 8px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>üñä Rotulagem de Imagens - YOLO</h2>

<label>
  Classe atual:
  <select id="classSelect">
    <option value="0">üì∫ Display</option>
    <option value="1">üîò Bot√£o</option>
  </select>
</label>

<br><br>

<div class="container">
  <img id="image" src="" alt="Imagem para rotulagem">
  <canvas id="canvas"></canvas>
</div>

<br>
<button id="nextBtn">‚û°Ô∏è Pr√≥xima</button>
<button id="submitBtn">‚úÖ Salvar Label</button>
<button id="deleteBtn">üóë Deletar</button>

<script>
const image = document.getElementById("image");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
const deleteBtn = document.getElementById("deleteBtn");
const classSelect = document.getElementById("classSelect");

const BACKEND_NEXT = "http://localhost:8000/next_label";
const BACKEND_LABEL = "http://localhost:8000/label";
const BACKEND_DELETE = "http://localhost:8000/delete";

let boxes = [];
let startX = 0, startY = 0;
let isDrawing = false;
let currentFilename = "";

// ===========================
// Ajusta canvas ao tamanho da imagem
// ===========================
function resizeCanvas() {
  canvas.width = image.width;
  canvas.height = image.height;
  drawBoxes();
}

// ===========================
// Desenhar bounding boxes
// ===========================
function drawBoxes() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  boxes.forEach((b, idx) => {
    ctx.strokeStyle = b.class_id === 0 ? "lime" : "cyan";
    ctx.fillStyle   = ctx.strokeStyle;
    ctx.lineWidth = 2;

    ctx.strokeRect(b.x, b.y, b.w, b.h);
    ctx.fillText(
      `${idx + 1} - ${b.class_id === 0 ? "Display" : "Bot√£o"}`,
      b.x + 4,
      b.y + 14
    );
  });
}

// ===========================
// Mouse events
// ===========================
canvas.addEventListener("mousedown", (e) => {
  const rect = canvas.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;
  isDrawing = true;
});

canvas.addEventListener("mousemove", (e) => {
  if (!isDrawing) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  drawBoxes();
  ctx.strokeStyle = "red";
  ctx.strokeRect(startX, startY, x - startX, y - startY);
});

canvas.addEventListener("mouseup", (e) => {
  if (!isDrawing) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  boxes.push({
    x: startX,
    y: startY,
    w: x - startX,
    h: y - startY,
    class_id: Number(classSelect.value)
  });

  isDrawing = false;
  drawBoxes();
});

// ===========================
// Carregar pr√≥xima imagem
// ===========================
async function loadNextImage() {
  const res = await fetch(BACKEND_NEXT);
  const data = await res.json();

  if (data.status === "empty") {
    alert("‚úÖ Todas as imagens foram rotuladas!");
    image.src = "";
    canvas.width = canvas.height = 0;
    boxes = [];
    currentFilename = "";
    return;
  }

  image.src = data.image;
  currentFilename = data.filename;
  boxes = [];

  image.onload = resizeCanvas;
}

// ===========================
// Enviar labels (YOLO)
// ===========================
async function submitLabels() {
  if (!currentFilename) return;

  const labels = boxes.map(b => ({
    class_id: b.class_id,
    x: (b.x + b.w / 2) / canvas.width,
    y: (b.y + b.h / 2) / canvas.height,
    w: b.w / canvas.width,
    h: b.h / canvas.height
  }));

  await fetch(BACKEND_LABEL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      filename: currentFilename,
      labels
    })
  });

  loadNextImage();
}

// ===========================
// Deletar imagem
// ===========================
async function deleteImage() {
  if (!currentFilename) return;

  await fetch(BACKEND_DELETE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ filename: currentFilename })
  });

  loadNextImage();
}

// ===========================
// Bot√µes
// ===========================
nextBtn.onclick = loadNextImage;
submitBtn.onclick = submitLabels;
deleteBtn.onclick = deleteImage;

// Inicializa
loadNextImage();
</script>

</body>
</html>
