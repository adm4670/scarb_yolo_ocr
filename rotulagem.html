<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Rotulagem YOLO</title>

  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }

    .container {
      position: relative;
      display: inline-block;
    }

    #image {
      max-width: 800px;
      border-radius: 8px;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      cursor: crosshair;
    }

    button {
      margin: 8px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>üñä Rotulagem de Imagens - YOLO</h2>

<div class="container">
  <img id="image" src="" alt="Imagem para rotulagem">
  <canvas id="canvas"></canvas>
</div>

<br>
<button id="nextBtn">‚û°Ô∏è Pr√≥xima</button>
<button id="submitBtn">‚úÖ Salvar Label</button>
<button id="deleteBtn">üóë Deletar</button>

<script>
const image = document.getElementById("image");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
const deleteBtn = document.getElementById("deleteBtn");

const BACKEND_NEXT = "http://localhost:8000/next_label";
const BACKEND_LABEL = "http://localhost:8000/label";
const BACKEND_DELETE = "http://localhost:8000/delete";

let boxes = [];
let startX = 0, startY = 0;
let isDrawing = false;
let currentFilename = "";

// ===========================
// Redimensiona o canvas para a imagem
// ===========================
function resizeCanvas() {
  canvas.width = image.width;
  canvas.height = image.height;
  drawBoxes();
}

// ===========================
// Desenhar todos os bounding boxes
// ===========================
function drawBoxes() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "lime";
  ctx.lineWidth = 2;
  ctx.fillStyle = "lime";
  boxes.forEach((b, idx) => {
    ctx.strokeRect(b.x, b.y, b.w, b.h);
    ctx.fillText(`#${idx+1}`, b.x + 3, b.y + 12);
  });
}

// ===========================
// Eventos do mouse para desenho
// ===========================
canvas.addEventListener("mousedown", (e) => {
  const rect = canvas.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;
  isDrawing = true;
});

canvas.addEventListener("mousemove", (e) => {
  if (!isDrawing) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const w = x - startX;
  const h = y - startY;

  drawBoxes();
  ctx.strokeStyle = "red";
  ctx.strokeRect(startX, startY, w, h);
});

canvas.addEventListener("mouseup", (e) => {
  if (!isDrawing) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const w = x - startX;
  const h = y - startY;

  boxes.push({ x: startX, y: startY, w: w, h: h });
  isDrawing = false;
  drawBoxes();
});

// ===========================
// Carregar pr√≥xima imagem
// ===========================
async function loadNextImage() {
  const res = await fetch(BACKEND_NEXT);
  const data = await res.json();

  if (data.status === "empty") {
    alert("‚úÖ Todas as imagens foram rotuladas!");
    image.src = "";
    canvas.width = canvas.height = 0;
    boxes = [];
    currentFilename = "";
    return;
  }

  image.src = data.image;
  currentFilename = data.filename;
  boxes = [];

  image.onload = resizeCanvas;
}

// ===========================
// Enviar labels para backend
// ===========================
async function submitLabels() {
  if (!currentFilename) return;
  const labels = boxes.map(b => ({
    x: b.x / canvas.width,
    y: b.y / canvas.height,
    w: b.w / canvas.width,
    h: b.h / canvas.height,
    class_id: 0   // Ajuste conforme a classe desejada
  }));

  const payload = {
    filename: currentFilename,
    labels: labels
  };

  await fetch(BACKEND_LABEL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  loadNextImage();
}

// ===========================
// Deletar imagem
// ===========================
async function deleteImage() {
  if (!currentFilename) return;

  const payload = { filename: currentFilename };
  await fetch(BACKEND_DELETE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  loadNextImage();
}

// ===========================
// Bot√µes
// ===========================
nextBtn.onclick = loadNextImage;
submitBtn.onclick = submitLabels;
deleteBtn.onclick = deleteImage;

// ===========================
// Inicializa primeira imagem
// ===========================
loadNextImage();

</script>

</body>
</html>
